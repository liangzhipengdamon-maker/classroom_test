# class_mvp.py â€”â€” é›…è¶£æ™ºèƒ½è¯¾å ‚åé¦ˆç³»ç»Ÿï¼ˆæ•™å¸ˆä¸Šä¼ +å®¶é•¿ç¾¤æ¨é€+å­¦ç”Ÿæ¡£æ¡ˆï¼‰
# ä¾èµ–å®‰è£…: pip install flask pillow requests
# è¿è¡Œå‘½ä»¤: python class_mvp.py
# è®¿é—®åœ°å€: http://æ‚¨çš„æœåŠ¡å™¨IP:5000/upload ï¼ˆæ•™å¸ˆä¸Šä¼ é¡µï¼‰

from flask import Flask, request, render_template_string, send_from_directory, jsonify
from PIL import Image, ImageDraw, ImageFont
import os, time, uuid, json, base64, hashlib
import requests
from datetime import datetime

app = Flask(__name__)
UPLOAD_FOLDER = 'uploads'
os.makedirs(UPLOAD_FOLDER, exist_ok=True)

# â–¶â–¶â–¶ã€å…³é”®é…ç½®ã€‘æ‚¨åªéœ€ä¿®æ”¹è¿™3è¡Œ â–¶â–¶â–¶
WECHAT_WEBHOOK = "https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=51a874dd-0727-4ce9-895e-8b090a4c3536"  # 1. ä¼ä¸šå¾®ä¿¡æœºå™¨äººåœ°å€
SCHOOL_NAME = "é›…è¶£å ‚ä¹¦ç”»"  # 2. æ‚¨çš„æœºæ„åç§°ï¼ˆæ˜¾ç¤ºåœ¨æ°´å°ä¸­ï¼‰
DOMAIN = "http://129.204.181.116:5000"  # 3. æœåŠ¡å™¨å…¬ç½‘åœ°å€ï¼ˆéƒ¨ç½²åæ”¹ä¸ºæ‚¨çš„IPæˆ–åŸŸåï¼‰
# â–¶â–¶â–¶ é…ç½®ç»“æŸ â–¶â–¶â–¶

# ğŸ“± æ•™å¸ˆæ‰‹æœºç«¯ä¸Šä¼ é¡µé¢ï¼ˆæç®€è®¾è®¡ï¼Œä¸“ä¸ºæ‰‹æœºæµè§ˆå™¨ä¼˜åŒ–ï¼‰
@app.route('/upload')
def upload_page():
    return render_template_string('''
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>é›…è¶£æ™ºèƒ½è¯¾å ‚åé¦ˆï½œä¸Šä¼ </title>
        <style>
            * { margin:0; padding:0; box-sizing:border-box; font-family:"PingFang SC","Microsoft YaHei",sans-serif; }
            body { padding:20px; background:#f8f9fa; color:#333; }
            .container { max-width:600px; margin:0 auto; background:white; border-radius:16px; padding:25px; box-shadow:0 4px 12px rgba(0,0,0,0.05); }
            h2 { text-align:center; color:#e74c3c; margin-bottom:25px; font-size:24px; }
            .form-group { margin-bottom:20px; }
            label { display:block; margin-bottom:8px; font-weight:500; color:#2c3e50; }
            input, select, textarea { width:100%; padding:14px; border:1px solid #ddd; border-radius:12px; font-size:16px; }
            input[type="file"] { padding:8px; }
            .btn { background:#e74c3c; color:white; border:none; border-radius:12px; padding:16px; font-size:18px; font-weight:600; width:100%; margin-top:10px; }
            .btn:active { background:#c0392b; transform:scale(0.98); }
            .tips { background:#fff8e1; padding:15px; border-radius:12px; margin-top:20px; font-size:14px; line-height:1.5; }
        </style>
    </head>
    <body>
        <div class="container">
            <h2>âœï¸ ä¹¦æ³•è¯¾å ‚è®°å½•</h2>
            <form id="uploadForm" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="class">ç­çº§</label>
                    <select id="class" name="class_name" required>
                        <option value="">è¯·é€‰æ‹©ç­çº§</option>
                        <option value="ä¸€å¹´çº§æ¥·ä¹¦åŸºç¡€ç­">ä¸€å¹´çº§æ¥·ä¹¦åŸºç¡€ç­</option>
                        <option value="äºŒå¹´çº§è¡Œä¹¦å¯è’™ç­">äºŒå¹´çº§è¡Œä¹¦å¯è’™ç­</option>
                        <option value="ä¸‰å¹´çº§åˆ›ä½œæå‡ç­">ä¸‰å¹´çº§åˆ›ä½œæå‡ç­</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="student">å­¦ç”Ÿå§“å</label>
                    <input type="text" id="student" name="student_name" placeholder="ä¾‹ï¼šå¼ æ˜è½©" required>
                </div>
                
                <div class="form-group">
                    <label for="posture">ä¹¦å†™å§¿åŠ¿ç…§ç‰‡ï¼ˆä¾§æ‹ï¼‰</label>
                    <input type="file" id="posture" name="posture" accept="image/*" capture="environment" required>
                </div>
                
                <div class="form-group">
                    <label for="work">å½“å ‚ä½œå“ç…§ç‰‡</label>
                    <input type="file" id="work" name="work" accept="image/*" capture="environment" required>
                </div>
                
                <div class="form-group">
                    <label for="comment">æ•™å¸ˆè¯„è¯­ï¼ˆå…·ä½“ä¸€ç‚¹æ›´æš–å¿ƒï¼‰</label>
                    <textarea id="comment" name="comment" rows="3" placeholder="ä¾‹ï¼šä»Šå¤©'æº'è„šèˆ’å±•æœ‰è¿›æ­¥ï¼æ³¨æ„æ¨ªç”»å·¦ä½å³é«˜" required></textarea>
                </div>
                
                <button type="submit" class="btn">æäº¤ç»™å®¶é•¿ç¾¤</button>
            </form>
            
            <div class="tips">
                <strong>ğŸ“Œ æ¸©é¦¨æç¤º</strong><br>
                â€¢ å§¿åŠ¿ç…§è¯·ä¾§æ‹ï¼Œèƒ½çœ‹æ¸…å¤´/è‚©/èƒŒ<br>
                â€¢ ä½œå“ç…§å…‰çº¿è¦å……è¶³ï¼Œå››è§’å®Œæ•´<br>
                â€¢ è¯„è¯­è¶Šå…·ä½“ï¼Œå®¶é•¿è¶Šå®‰å¿ƒ
            </div>
        </div>
        
        <script>
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.querySelector('.btn');
            btn.innerHTML = 'â³ ä¸Šä¼ ä¸­...';
            btn.disabled = true;
            
            const formData = new FormData(e.target);
            
            try {
                const response = await fetch('/api/submit', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('ä¸Šä¼ æˆåŠŸï¼ä½œå“å·²å‘é€è‡³å®¶é•¿ç¾¤ï¼Œå­¦ç”Ÿæ¡£æ¡ˆå·²æ›´æ–°');
                    e.target.reset();
                } else {
                    alert('å¤±è´¥: ' + result.msg);
                }
            } catch (error) {
                alert('ç½‘ç»œé”™è¯¯: ' + error.message);
            } finally {
                btn.innerHTML = 'æäº¤ç»™å®¶é•¿ç¾¤';
                btn.disabled = false;
            }
        });
        </script>
    </body>
    </html>
    ''')

# ğŸš€ æ ¸å¿ƒAPIï¼šå¤„ç†ä¸Šä¼ ã€ç”Ÿæˆæ‹¼å›¾ã€æ¨é€åˆ°ä¼ä¸šå¾®ä¿¡
@app.route('/api/submit', methods=['POST'])
def submit_record():
    try:
        # 1. è·å–è¡¨å•æ•°æ®
        class_name = request.form['class_name']
        student_name = request.form['student_name']
        comment = request.form['comment']
        posture = request.files['posture']
        work = request.files['work']
        
        # 2. ç”Ÿæˆå”¯ä¸€IDå’Œæ–‡ä»¶å
        uid = str(uuid.uuid4())[:8]
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        posture_path = f"{UPLOAD_FOLDER}/p_{uid}.jpg"
        work_path = f"{UPLOAD_FOLDER}/w_{uid}.jpg"
        collage_path = f"{UPLOAD_FOLDER}/c_{uid}.jpg"
        
        # 3. ä¿å­˜åŸå§‹ç…§ç‰‡
        posture.save(posture_path)
        work.save(work_path)
        
        # 4. ç”Ÿæˆæ‹¼å›¾ï¼ˆä¸“ä¸ºä¹¦æ³•ä¼˜åŒ–çš„æ’ç‰ˆï¼‰
        create_collage(posture_path, work_path, collage_path, class_name, student_name, comment)
        
        # 5. å‘é€åˆ°ä¼ä¸šå¾®ä¿¡ï¼ˆå®¶é•¿ç¾¤ï¼‰
        image_url = f"{DOMAIN}/{os.path.basename(collage_path)}"
        success, msg = send_to_wechat(collage_path, class_name, student_name, comment, image_url)
        
        if not success:
            return jsonify({"success": False, "msg": f"ç¾¤æ¨é€å¤±è´¥: {msg}"})
        
        # 6. ä¿å­˜åˆ°æœ¬åœ°æ•°æ®åº“ï¼ˆSQLiteå¤ªé‡ï¼Œç”¨JSONæ–‡ä»¶å®ç°ï¼‰
        record = {
            "id": uid,
            "class": class_name,
            "student": student_name,
            "comment": comment,
            "posture_url": f"/{os.path.basename(posture_path)}",
            "work_url": f"/{os.path.basename(work_path)}",
            "collage_url": f"/{os.path.basename(collage_path)}",
            "created_at": datetime.now().isoformat(),
            "group": class_name  # ç”¨äºåŒºåˆ†ç­çº§ç¾¤
        }
        
        # ç®€æ˜“æ•°æ®å­˜å‚¨ï¼ˆå®é™…ç”Ÿäº§ç¯å¢ƒå»ºè®®ç”¨SQLiteï¼‰
        db_path = "records.json"
        records = []
        if os.path.exists(db_path):
            with open(db_path, 'r', encoding='utf-8') as f:
                records = json.load(f)
        records.append(record)
        with open(db_path, 'w', encoding='utf-8') as f:
            json.dump(records, f, ensure_ascii=False, indent=2)
        
        return jsonify({
            "success": True,
            "msg": "å·²å‘é€åˆ°å®¶é•¿ç¾¤ï¼",
            "record_id": uid,
            "archive_url": f"{DOMAIN}/archive?student={student_name}&class={class_name}"
        })
    
    except Exception as e:
        return jsonify({"success": False, "msg": str(e)})

# ğŸ–¼ï¸ ç”Ÿæˆä¹¦æ³•ä¸“ç”¨æ‹¼å›¾ï¼ˆå«å§¿åŠ¿+ä½œå“+è¯„è¯­+æ°´å°ï¼‰
def create_collage(posture_path, work_path, output_path, class_name, student_name, comment):
    # åŠ è½½å¹¶è°ƒæ•´å›¾ç‰‡å°ºå¯¸
    posture_img = Image.open(posture_path).convert("RGB")
    work_img = Image.open(work_path).convert("RGB")
    
    # ç»Ÿä¸€å®½åº¦ï¼ˆæ‰‹æœºç«–å±å‹å¥½ï¼‰
    target_width = 750
    posture_ratio = target_width / posture_img.width
    work_ratio = target_width / work_img.width
    
    posture_img = posture_img.resize((target_width, int(posture_img.height * posture_ratio)), Image.LANCZOS)
    work_img = work_img.resize((target_width, int(work_img.height * work_ratio)), Image.LANCZOS)
    
    # åˆ›å»ºæ‹¼å›¾ç”»å¸ƒï¼ˆé«˜åº¦=å§¿åŠ¿é«˜+ä½œå“é«˜+åº•éƒ¨æ–‡å­—åŒºï¼‰
    total_height = posture_img.height + work_img.height + 250
    collage = Image.new("RGB", (target_width, total_height), "#ffffff")
    
    # ç²˜è´´å›¾ç‰‡
    collage.paste(posture_img, (0, 0))
    collage.paste(work_img, (0, posture_img.height))
    
    # æ·»åŠ æ–‡å­—ï¼ˆä½¿ç”¨ç³»ç»Ÿå­—ä½“ï¼Œé¿å…ä¸­æ–‡ä¹±ç ï¼‰
    draw = ImageDraw.Draw(collage)
    try:
        font_large = ImageFont.truetype("simhei.ttf", 36)  # Windows
    except:
        try:
            font_large = ImageFont.truetype("/System/Library/Fonts/PingFang.ttc", 36)  # Mac
        except:
            font_large = ImageFont.load_default()
    
    try:
        font_small = ImageFont.truetype("simhei.ttf", 28)
    except:
        font_small = ImageFont.load_default()
    
    # è¯¾æ¬¡ä¿¡æ¯
    now = datetime.now().strftime("%Y-%m-%d %H:%M")
    course_info = f"{now} | {class_name}"
    draw.text((30, posture_img.height + work_img.height + 20), course_info, fill="#2c3e50", font=font_small)
    
    # å­¦ç”Ÿè¯„è¯­
    draw.text((30, posture_img.height + work_img.height + 60), f"ğŸ“ {student_name}ï¼š{comment}", 
              fill="#27ae60", font=font_large)
    
    # æœºæ„æ°´å°
    watermark = f"é›…è¶£å ‚ï½œ{SCHOOL_NAME}"
    draw.text((30, posture_img.height + work_img.height + 120), watermark, fill="#95a5a6", font=font_small)
    
    # ä¿å­˜
    collage.save(output_path, quality=95, optimize=True)

# ğŸ’¬ å‘é€åˆ°ä¼ä¸šå¾®ä¿¡ï¼ˆå®¶é•¿ç¾¤ï¼‰
def send_to_wechat(image_path, class_name, student_name, comment, image_url):
    try:
        # ä¼ä¸šå¾®ä¿¡è¦æ±‚ï¼šå›¾ç‰‡éœ€å…ˆä¸Šä¼ åˆ°å…¶æœåŠ¡å™¨ï¼ˆæˆ‘ä»¬ç®€åŒ–ï¼šç›´æ¥å‘å¡ç‰‡+å›¾ç‰‡é“¾æ¥ï¼‰
        msg_data = {
            "msgtype": "news",
            "news": {
                "articles": [
                    {
                        "title": f"ã€è¯¾å ‚è®°å½•ã€‘{student_name} ({class_name})",
                        "description": comment,
                        "url": image_url,
                        "picurl": image_url
                    }
                ]
            }
        }
        
        response = requests.post(WECHAT_WEBHOOK, json=msg_data, timeout=10)
        result = response.json()
        
        if result.get('errcode') == 0:
            return True, "å·²å‘é€åˆ°å®¶é•¿ç¾¤"
        else:
            return False, result.get('errmsg', 'æœªçŸ¥é”™è¯¯')
    
    except Exception as e:
        return False, str(e)

# ğŸ“‚ é™æ€æ–‡ä»¶æœåŠ¡ï¼ˆå›¾ç‰‡ã€æ¡£æ¡ˆé¡µï¼‰
@app.route('/<path:filename>')
def serve_file(filename):
    if filename.endswith('.jpg'):
        return send_from_directory(UPLOAD_FOLDER, filename)
    return "æ–‡ä»¶ä¸å­˜åœ¨", 404

# ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶é•¿æŸ¥çœ‹å­¦ç”Ÿæ¡£æ¡ˆé¡µ
@app.route('/archive')
def student_archive():
    student_name = request.args.get('student', '')
    class_name = request.args.get('class', '')
    
    # ä»ç®€æ˜“æ•°æ®åº“åŠ è½½è®°å½•
    records = []
    if os.path.exists("records.json"):
        with open("records.json", 'r', encoding='utf-8') as f:
            all_records = json.load(f)
            # è¿‡æ»¤å½“å‰å­¦ç”Ÿ
            records = [r for r in all_records 
                      if r['student'] == student_name and r['class'] == class_name]
    
    # æŒ‰æ—¶é—´å€’åºæ’åˆ—
    records.sort(key=lambda x: x['created_at'], reverse=True)
    
    return render_template_string('''
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>{{ student_name }}çš„æˆé•¿æ¡£æ¡ˆ - {{ SCHOOL_NAME }}</title>
        <style>
            * { margin:0; padding:0; box-sizing:border-box; font-family:"PingFang SC","Microsoft YaHei",sans-serif; }
            body { background:#f8f9fa; padding:15px; }
            .header { text-align:center; padding:20px 0; background:white; border-radius:16px; margin-bottom:20px; box-shadow:0 2px 10px rgba(0,0,0,0.05); }
            h1 { color:#e74c3c; font-size:24px; }
            .record { background:white; border-radius:16px; padding:20px; margin-bottom:15px; box-shadow:0 2px 8px rgba(0,0,0,0.08); }
            .record-date { color:#7f8c8d; font-size:14px; margin-bottom:10px; }
            .record-img { width:100%; border-radius:12px; margin:10px 0; }
            .record-comment { color:#27ae60; font-size:16px; padding:8px 0; }
            .tips { background:#e8f4fd; padding:15px; border-radius:12px; margin-top:20px; font-size:14px; }
        </style>
    </head>
    <body>
        <div class="header">
            <h1>ğŸ¨ {{ student_name }}çš„å¢¨é¦™æˆé•¿</h1>
            <p>{{ class_name }} Â· å…± {{ records|length }} æ¬¡è¯¾å ‚è®°å½•</p>
        </div>
        
        {% for record in records %}
        <div class="record">
            <div class="record-date">{{ record.created_at[:16].replace('T', ' ') }}</div>
            <img class="record-img" src="{{ record.collage_url }}" alt="è¯¾å ‚è®°å½•">
            <div class="record-comment">ğŸ“ {{ record.comment }}</div>
        </div>
        {% endfor %}
        
        <div class="tips">
            <strong>ğŸ’¡ å°æç¤º</strong><br>
            â€¢ é•¿æŒ‰å›¾ç‰‡å¯ä¿å­˜åˆ°æ‰‹æœº<br>
            â€¢ ç‚¹å³ä¸Šè§’ã€ŒÂ·Â·Â·ã€å¯åˆ†äº«ç»™å®¶äºº
        </div>
    </body>
    </html>
    ''', student_name=student_name, class_name=class_name, records=records, SCHOOL_NAME=SCHOOL_NAME)

# ğŸ  é¦–é¡µï¼ˆé‡å®šå‘åˆ°ä¸Šä¼ é¡µï¼‰
@app.route('/')
def home():
    return '<script>window.location.href="/upload"</script>'

if __name__ == '__main__':
    print(f"\nğŸš€ é›…è¶£æ™ºèƒ½è¯¾å ‚åé¦ˆMVPå·²å¯åŠ¨ï¼")
    print(f"ğŸ“± æ•™å¸ˆä¸Šä¼ åœ°å€: {DOMAIN}/upload")
    print(f"ğŸ“ ğŸ’¡ è¯·é€šè¿‡å…¬ç½‘IPè®¿é—®,é localhost")
    print("âš ï¸ é‡è¦éƒ¨ç½²æç¤º (é¦–æ¬¡è¿è¡Œå):")
    print("1. ç”³è¯·ä¼ä¸šå¾®ä¿¡æœºå™¨äºº: ç¾¤ä¸»åœ¨ä¼ä¸šå¾®ä¿¡â†’ç¾¤â†’å³ä¸Šè§’Â·Â·Â·â†’ç¾¤æœºå™¨äººâ†’æ·»åŠ ")
    print("2. æ›¿æ¢ä»£ç ä¸­çš„ WECHAT_WEBHOOK ä¸ºæ‚¨çš„æœºå™¨äººåœ°å€")
    print("3. å°† DOMAIN æ”¹ä¸ºæ‚¨çš„æœåŠ¡å™¨å…¬ç½‘IPæˆ–åŸŸå")
    print("4. äº‘æœåŠ¡å™¨éœ€å¼€æ”¾ 5000 ç«¯å£ (å®‰å…¨ç»„è§„åˆ™)")
    
    app.run(host='0.0.0.0', port=5000, debug=False)